<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>Inventario</title>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; margin: 0; background:
        radial-gradient(1200px 600px at 10% -10%, rgba(247, 201, 72, 0.08), transparent 60%),
        radial-gradient(1000px 500px at 120% 0%, rgba(78, 52, 46, 0.08), transparent 55%),
        radial-gradient(circle at top, #fff8ec, #f5ede1 60%);
        color: #3e2723; }
      header { background: linear-gradient(135deg, #4e342e, #3e2723); color: #fff; padding: 1.2rem 1.5rem; display: flex; align-items: baseline; justify-content: space-between; }
      main { padding: 1.25rem; max-width: 1100px; margin: 0 auto; }
      .card { background: #fff; border-radius: 14px; padding: 1rem; box-shadow: 0 12px 28px rgba(30,20,15,0.12); border: 1px solid rgba(78,52,46,0.12); }
      .grid { display: grid; grid-template-columns: 1fr 360px; gap: 1rem; }
      @media (max-width: 960px) { .grid { grid-template-columns: 1fr; } }
      table { width: 100%; border-collapse: separate; border-spacing: 0; }
      thead th { text-align: left; background: rgba(78,52,46,0.08); color: #3e2723; padding: 10px; position: sticky; top: 0; }
      tbody td { padding: 10px; border-top: 1px solid rgba(78,52,46,0.12); }
      .adjust { display: grid; gap: 0.75rem; }
      .adjust .field { display: flex; flex-direction: column; gap: 0.3rem; }
      label { font-size: 0.9rem; color: rgba(62,39,35,0.9); }
      input, select { padding: 0.55rem 0.6rem; border-radius: 8px; border: 1px solid rgba(78,52,46,0.25); }
      button { padding: 0.6rem 0.9rem; border-radius: 999px; border: none; background: linear-gradient(135deg, #4e342e, #3e2723); color: #fff; font-weight: 600; cursor: pointer; }
      .muted { color: rgba(62,39,35,0.7); font-size: 0.9rem; }
      .actions { display: flex; gap: 0.5rem; align-items: center; }
      .row { display: flex; gap: 0.5rem; align-items: center; }
      .right { text-align: right; }
      .status-badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.2rem 0.75rem; border-radius:999px; font-size:0.78rem; font-weight:600; border:1px solid rgba(78,52,46,0.2); text-transform:uppercase; letter-spacing:0.04em; }
      .status-alert { color:#c62828; background:rgba(198,40,40,0.12); border-color:rgba(198,40,40,0.4); }
      .status-processed { color:#2e7d32; background:rgba(46,125,50,0.12); border-color:rgba(46,125,50,0.4); }
      .action-btn { padding:0.45rem 0.9rem; border-radius:999px; border:none; background:linear-gradient(135deg,#ffcc80,#ffb74d); color:#4e342e; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(78,52,46,0.25); transition:transform 0.2s ease; }
      .action-btn:hover { transform:translateY(-1px); }
      .action-btn:disabled { opacity:0.55; cursor:not-allowed; box-shadow:none; }
      .timer { min-width:190px; }
      .timer-text { font-size:0.78rem; color:rgba(62,39,35,0.7); margin-bottom:0.35rem; }
      .progress-track { width:100%; height:7px; background:rgba(78,52,46,0.15); border-radius:999px; overflow:hidden; margin-bottom:0.3rem; }
      .progress-fill { height:100%; background:linear-gradient(90deg,#f7c948,#ff8f00); }
      .timer-range { width:100%; accent-color:#f7c948; cursor:not-allowed; }
      /* Radial admin menu styles (shared with other admin pages) */
      .admin-menu { position: fixed; right: 24px; bottom: 24px; z-index: 1000; }
      .admin-menu .main { position: relative; display: flex; justify-content: center; align-items: center; width: 188px; height: 188px; background-color: rgba(255,255,255,0.21); border-radius: 14px; backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 20px 30px -10px rgba(38,57,77,0.35); }
      .admin-menu .navigation { position: relative; width: 44px; height: 44px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.5s; }
      .admin-menu .navigation span { position: absolute; width: 8px; height: 8px; background: #fff; transform: translate(calc(14px * var(--x)), calc(14px * var(--y))); transition: transform 0.5s, width 0.5s, height 0.5s, background 0.5s, border-radius 0.5s; transition-delay: calc(0.06s * var(--i)); display: flex; justify-content: center; align-items: center; border-radius: 4px; border: 1px solid rgba(78,52,46,0.15); box-shadow: 0 6px 16px rgba(30,20,15,0.18); }
      .admin-menu .navigation span a { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #fff; text-decoration: none; }
      .admin-menu .navigation.active span { width: 48px; height: 48px; background: rgba(62,39,35,0.92); transform: translate(calc(60px * var(--x)), calc(60px * var(--y))); border-radius: 10px; border: 1px solid rgba(255,255,255,0.35); }
      .admin-menu .navigation span ion-icon { transition: 0.5s; font-size: 0em; color: #fff; }
      .admin-menu .navigation.active span ion-icon { font-size: 1.35em; }
      .admin-menu .navigation.active span:hover ion-icon { color: #f7c948; filter: drop-shadow(0 0 2px #f7c948) drop-shadow(0 0 5px #f7c948) drop-shadow(0 0 12px #f7c948); }
      .admin-menu .close { position: absolute; width: 8px; height: 8px; background: #fff; transition: 0.5s; transition-delay: 0.35s; pointer-events: none; display: flex; justify-content: center; align-items: center; border-radius: 4px; }
      .admin-menu .navigation.active ~ .close { width: 44px; height: 44px; pointer-events: initial; transition-delay: 0.75s; background: #f7c948; border-radius: 10px; box-shadow: 0 10px 22px rgba(30,20,15,0.22); }
      .admin-menu .navigation ~ .close ion-icon { font-size: 2em; scale: 0; color: #3e2723; transition: 0.5s; }
      .admin-menu .navigation.active ~ .close ion-icon { scale: 1; transition-delay: 1s; }
    </style>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  </head>
  <body>
    <header>
      <div>
        <h1 style="margin:0">Inventario</h1>
        <p class="muted" style="margin:0.2rem 0 0">Livelli stock e regolazioni rapide</p>
      </div>
      <div class="actions">
        <a href="/admin/" style="color:#fff; text-decoration:none; font-weight:600">Area Staff</a>
      </div>
    </header>
    <main>
      <div class="grid">
        <div class="card" style="overflow:auto; max-height: 70vh;">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>Nome</th>
                <th class="right">Quantità</th>
                <th>Unità</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td><code>{{ it.sku }}</code></td>
                <td>{{ it.name }}</td>
                <td class="right">{{ '%.2f'|format(it.qty) }}</td>
                <td>{{ it.unit }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Regola inventario</h3>
          <form class="adjust" method="post" action="/admin/inventory/adjust">
            <div class="field">
              <label for="sku">SKU</label>
              <input id="sku" name="sku" placeholder="e.g., COFFEE-BEANS" required />
            </div>
            <div class="field">
              <label for="delta">Delta</label>
              <input id="delta" name="delta" type="number" step="0.01" placeholder="e.g., 500" required />
            </div>
            <div class="field">
              <label for="unit">Unità</label>
              <input id="unit" name="unit" placeholder="ml/g/pcs" />
            </div>
            <div class="field">
              <label for="reason">Motivo</label>
              <select id="reason" name="reason">
                <option value="adjust">Adjust</option>
                <option value="receive">Receive</option>
                <option value="waste">Waste</option>
                <option value="transfer">Transfer</option>
              </select>
            </div>
            <div>
              <button type="submit">Applica</button>
            </div>
          </form>
          <p class="muted">Suggerimento: valori positivi aggiungono stock; negativi sottraggono.</p>
        </div>
      </div>

      <div class="card" style="margin-top:1.5rem; overflow:auto;">
        <h3 style="margin-top:0">Allarmi di reintegro &amp; alert</h3>
        <p class="muted">Simile alla vista Ordini Chiusi: ogni alert indica il prodotto da ordinare, stato, quantità suggerita e fornitore con prezzo stimato.</p>
        <table>
          <thead>
            <tr>
              <th>Prodotto</th>
              <th>Stato allarme</th>
              <th>Q.tà suggerita</th>
              <th>Fornitore · Prezzo</th>
              <th>Azione / Timer</th>
            </tr>
          </thead>
          <tbody>
            {% if supply_orders %}
              {% for order in supply_orders %}
                <tr>
                  <td>{{ order.product }}</td>
                  <td>
                    {% if order.state == "alert" %}
                      <span class="status-badge status-alert">Alert</span>
                    {% else %}
                      <span class="status-badge status-processed">{{ order.state }}</span>
                    {% endif %}
                  </td>
                  <td>{{ order.qty_text }}</td>
                  <td>{{ order.supplier_quote }}</td>
                  <td>
                    {% if order.actionable %}
                      <button class="action-btn" data-ack-order="{{ order.id }}">Acknowledge</button>
                      <div class="timer-text">Allarme {{ order.alert_time }}</div>
                    {% else %}
                      <div class="timer">
                        <div class="timer-text">Ack {{ order.ack_text }} · SLA {{ "%.0f"|format(order.sla_hours) }}h</div>
                        <div class="progress-track"><div class="progress-fill" style="width:{{ order.progress_pct }}%"></div></div>
                        <input type="range" class="timer-range" min="0" max="{{ order.sla_hours }}" value="{{ order.slider_value }}" disabled />
                      </div>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="5" class="muted">Nessun alert aperto.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="grid" style="margin-top:1.5rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr));">
        <div class="card" style="overflow:auto;">
          <h3 style="margin-top:0">Tabella Supply_Orders</h3>
          <p class="muted">Ogni alert crea subito un record da condividere con Acquisti/Venditori; l'ACK aggiorna lo stato.</p>
          <table>
            <thead>
              <tr>
                <th>ID Ordine</th>
                <th>Prodotto</th>
                <th>Fornitore</th>
                <th>Stato</th>
                <th>Q.tà</th>
                <th>Prezzo</th>
                <th>Alert → Ack</th>
              </tr>
            </thead>
            <tbody>
              {% if supply_orders %}
                {% for order in supply_orders %}
                  <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.product }}</td>
                    <td>{{ order.supplier_name }}</td>
                    <td>
                      {% if order.state == "alert" %}
                        <span class="status-badge status-alert">{{ order.state }}</span>
                      {% else %}
                        <span class="status-badge status-processed">{{ order.state }}</span>
                      {% endif %}
                    </td>
                    <td>{{ order.qty_text }}</td>
                    <td>{{ order.total_price }}</td>
                    <td>{{ order.alert_time }} → {{ order.ack_text or "—" }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="7" class="muted">Ancora nessun ordine fornitore registrato.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <p class="muted"><strong>DB actions:</strong> <code>INSERT</code> sul trigger dell'alert con <code>state = 'alert'</code>; quando viene cliccato “Acknowledge” eseguire <code>UPDATE</code> → <code>state='processed'</code> + <code>acknowledged_at</code> e apertura del timer SLA.</p>
        </div>

        <div class="card" style="overflow:auto;">
          <h3 style="margin-top:0">Anagrafica fornitori (seed)</h3>
          <p class="muted">Utilizzata per compilare suggerimenti automatici di quantità, fornitori e prezzi.</p>
          <table>
            <thead>
              <tr>
                <th>Fornitore</th>
                <th>Prodotti</th>
                <th>Lead time</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              {% if supplier_directory %}
                {% for supplier in supplier_directory %}
                  <tr>
                    <td>{{ supplier.name }}</td>
                    <td>
                      {% if supplier.products %}
                        {{ supplier.products|join(', ') }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>
                      {% if supplier.lead %}
                        {{ supplier.lead }} h
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ supplier.notes or "—" }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="muted">Nessun fornitore configurato.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Floating radial admin menu (same pattern as other pages) -->
    <div class="admin-menu">
      <div class="main">
        <div class="navigation" aria-label="Admin navigation" title="Menu">
          <span style="--i: 0; --x: 0; --y: -1"><a href="/admin/orders/closed" title="Ordini chiusi"><ion-icon name="time-outline"></ion-icon></a></span>
          <span style="--i: 1; --x: 1; --y: 0"><a href="/admin/dashboard" title="Dashboard"><ion-icon name="speedometer-outline"></ion-icon></a></span>
          <span style="--i: 2; --x: 0; --y: 1"><a href="/admin/orders" title="Ordini"><ion-icon name="receipt-outline"></ion-icon></a></span>
          <span style="--i: 3; --x: -1; --y: 0"><a href="/admin/inventory" title="Inventario"><ion-icon name="cube-outline"></ion-icon></a></span>
          <!-- Move Home to top-left to avoid overlap with Inventory -->
          <span style="--i: 6; --x: -1; --y: -1"><a href="/admin/" title="Home staff"><ion-icon name="home-outline"></ion-icon></a></span>
          <span style="--i: 4; --x: -1; --y: 1"><a href="/admin/login" title="Login"><ion-icon name="log-in-outline"></ion-icon></a></span>
          <span style="--i: 5; --x: 1; --y: 1"><a href="#" id="admin-logout-link" title="Logout"><ion-icon name="log-out-outline"></ion-icon></a></span>
        </div>
        <div class="close" aria-label="Chiudi" title="Chiudi"><ion-icon name="close-outline"></ion-icon></div>
      </div>
    </div>
    <script>
      (function () {
        const navigation = document.querySelector('.admin-menu .navigation');
        const closeBtn = document.querySelector('.admin-menu .close');
        const logoutLink = document.getElementById('admin-logout-link');
        if (navigation) navigation.addEventListener('click', () => navigation.classList.add('active'));
        if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); navigation.classList.remove('active'); });
        if (logoutLink) {
          logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try { await fetch('/admin/logout', { method: 'POST', credentials: 'same-origin' }); }
            finally { window.location.href = '/admin/login'; }
          });
        }
        document.querySelectorAll('[data-ack-order]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const orderId = btn.dataset.ackOrder;
            if (!orderId) return;
            btn.disabled = true;
            try {
              const res = await fetch(`/admin/inventory/supply-orders/${orderId}/ack`, {
                method: 'POST',
                credentials: 'same-origin'
              });
              if (!res.ok) throw new Error('Errore nel salvataggio');
              window.location.reload();
            } catch (err) {
              alert('Non è stato possibile confermare l\'alert. Riprova.');
              btn.disabled = false;
            }
          });
        });
      })();
    </script>
  </body>
  </html>
